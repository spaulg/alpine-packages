# Contributor: Simon Paulger <spaulger@codezen.co.uk>
# Maintainer: Simon Paulger <spaulger@codezen.co.uk>
pkgname="couchdb"
pkgver="3.0.1"
pkgrel=0
pkgdesc="Apache CouchDB is an open-source document-oriented NoSQL database, implemented in Erlang"
url="https://couchdb.apache.org/"
arch="all"
license="Apache-2.0"
depends="
        erlang
        erlang-asn1
        erlang-crypto
        erlang-erts
        erlang-inets
        erlang-os-mon
        erlang-public-key
        erlang-runtime-tools
        erlang-sasl
        erlang-ssl
        erlang-syntax-tools
        erlang-xmerl
        "
makedepends="
        alpine-sdk
        abuild
        make
        erlang-dev
        erlang-eunit
        erlang-reltool
        erlang-tools
        mozjs60-dev
        "
checkdepends="
        curl-dev
        python3
        python3-dev
        elixir
        "
pkgusers="couchdb"
pkggroups="couchdb"
install="
        $pkgname.pre-install
        $pkgname.post-install
        $pkgname.pre-deinstall
        "
source="https://downloads.apache.org/couchdb/source/$pkgver/apache-couchdb-$pkgver.tar.gz
        $pkgname.logrotate
        $pkgname.initd
        "
builddir="$srcdir/"
options="!fhs"

build() {
	cd "$builddir"/apache-couchdb-$pkgver
	./configure --spidermonkey-version=60
    make release
}

check() {
    cd "$builddir"/apache-couchdb-$pkgver
	make check
}

package() {
	cd "$builddir"/apache-couchdb-$pkgver

	mkdir -p "$pkgdir"/opt
	cp -R rel/couchdb "$pkgdir"/opt/couchdb
	rm -f "$pkgdir"/opt/couchdb/bin/couchdb.cmd

	chown -R couchdb:couchdb "$pkgdir"/opt/couchdb
	find "$pkgdir"/opt/couchdb -type d -exec chmod 0770 {} \;
	chmod 0644 "$pkgdir"/opt/couchdb/etc/*

	ln -s /var/log/couchdb "$pkgdir"/opt/couchdb/var/log/couchdb
	ln -s /var/lib/couchdb "$pkgdir"/opt/couchdb/data

	install -Dm644 "$srcdir"/$pkgname.logrotate "$pkgdir"/etc/logrotate.d/$pkgname
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
}
sha512sums="3c3e54b15232caa2dfcfa4be44df03304b9cb84e2d2d795050a2c7b751bb52a17722c280dbc5502728a5ca573ff40a157a9a2a586b4bdb82b65a12e1f4181474  apache-couchdb-3.0.1.tar.gz
fb37c3eb2eb9572dd482b7c41710afa1410cb8a69286b27eb99b4ad1419a887fc45d77ef22b6dbbc9ccdeaa3f065e867f5dc94ced09cb215ec981183a0caccfd  couchdb.logrotate
68114eb5b55764ce12e4e7c6feea27da9ec3eb5696aed156b35f902fae8c159a2acb7eb77051916fee3356640d936728c2eadcc300280036dc59e8e7ba427077  couchdb.initd"
